<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leaderboard</title>

<style>
  body {
    font-family: Arial;
    max-width: 700px;
    margin: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  th, td {
    border-bottom: 1px solid #ccc;
    padding: 10px;
    text-align: left;
  }

  th {
    background: #f2f2f2;
  }

  .rank-cell {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .rank-cell img {
    width: 30px;
    height: 30px;
    object-fit: contain;
  }

  .center {
    text-align: center;
  }
</style>
</head>

<body>

<h1>Leaderboard</h1>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Player</th>
      <th>Rank</th>
      <th class="center">Rank Stars</th>
      <th class="center">Total Stars</th>
    </tr>
  </thead>
  <tbody id="leaderboardBody">
    <tr>
      <td colspan="5" class="center">Loading...</td>
    </tr>
  </tbody>
</table>

<script type="module">
import { supabase } from './supabase.js';

const leaderboardBody = document.getElementById('leaderboardBody');

async function loadLeaderboard() {
  const { data, error } = await supabase
    .from('users')
    .select(`
      id,
      full_name,
      total_stars,
      ranks (
        rank_name,
        rank_image,
        stars
      )
    `)
    .order('total_stars', { ascending: false });

  leaderboardBody.innerHTML = '';

  if (error) {
    console.error(error);
    leaderboardBody.innerHTML =
      '<tr><td colspan="5">Failed to load leaderboard</td></tr>';
    return;
  }

  if (data.length === 0) {
    leaderboardBody.innerHTML =
      '<tr><td colspan="5">No players yet</td></tr>';
    return;
  }

  data.forEach((user, index) => {
    const rank = user.ranks || {};

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${user.full_name}</td>
      <td>
        <div class="rank-cell">
          ${rank.rank_image ? `<img src="${rank.rank_image}">` : ''}
          ${rank.rank_name || 'Unranked'}
        </div>
      </td>
      <td class="center">${rank.stars ?? 0}</td>
      <td class="center">${user.total_stars ?? 0}</td>
    `;

    leaderboardBody.appendChild(tr);
  });
}

loadLeaderboard();
</script>

</body>
</html>
