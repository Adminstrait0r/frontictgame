<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leaderboard – Top 3 Question Types</title>

<style>
  body {
    font-family: Arial;
    max-width: 700px;
    margin: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  th, td {
    border-bottom: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: top;
  }

  th {
    background: #f2f2f2;
  }

  .rank-cell {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .rank-cell img {
    width: 30px;
    height: 30px;
    object-fit: contain;
  }

  .center {
    text-align: center;
  }

  .type-list {
    margin: 0;
    padding-left: 20px;
    list-style-type: disc;
  }
</style>
</head>

<body>

<h1>Leaderboard – Top 3 Question Types</h1>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Player</th>
      <th>Rank</th>
      <th class="center">Rank Stars</th>
      <th class="center">Total Stars</th>
      <th>Top 3 Question Types</th>
    </tr>
  </thead>
  <tbody id="leaderboardBody">
    <tr>
      <td colspan="6" class="center">Loading...</td>
    </tr>
  </tbody>
</table>

<script type="module">
import { supabase } from './supabase.js';

const leaderboardBody = document.getElementById('leaderboardBody');

async function loadLeaderboard() {
  // Fetch users and ranks
  const { data: users, error } = await supabase
    .from('users_game') // adjust to your table name
    .select(`
      id,
      username,
      total_stars,
      top_questions_per_type,
      ranks (
        rank_name,
        rank_image,
        stars
      )
    `)
    .order('total_stars', { ascending: false });

  leaderboardBody.innerHTML = '';

  if (error) {
    console.error(error);
    leaderboardBody.innerHTML = '<tr><td colspan="6">Failed to load leaderboard</td></tr>';
    return;
  }

  if (!users || users.length === 0) {
    leaderboardBody.innerHTML = '<tr><td colspan="6">No players yet</td></tr>';
    return;
  }

  users.forEach((user, index) => {
    const rank = user.ranks || {};
    const types = user.top_questions_per_type || {};

    // Convert each type to array and sort descending by highest level
    const topTypes = Object.entries(types)
      .map(([type, levels]) => {
        const lvArray = Array.isArray(levels) ? levels : [levels];
        lvArray.sort((a, b) => b - a);
        return { type, lvArray };
      })
      .sort((a, b) => b.lvArray[0] - a.lvArray[0])
      .slice(0, 3)
      .map(t => `${t.type}: Lv ${t.lvArray.join(', ')}`);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${user.username}</td>
      <td>
        <div class="rank-cell">
          ${rank.rank_image ? `<img src="${rank.rank_image}">` : ''}
          ${rank.rank_name || 'Unranked'}
        </div>
      </td>
      <td class="center">${rank.stars ?? 0}</td>
      <td class="center">${user.total_stars ?? 0}</td>
      <td>
        <ul class="type-list">
          ${topTypes.map(t => `<li>${t}</li>`).join('')}
        </ul>
      </td>
    `;
    leaderboardBody.appendChild(tr);
  });
}

loadLeaderboard();
</script>

</body>
</html>
