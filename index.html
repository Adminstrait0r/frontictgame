<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quiz User Side</title>
<style>
  body { font-family: Arial; max-width: 700px; margin: 20px; }
  .question-container { margin-bottom: 20px; }
  .choice { display:flex; gap:10px; margin-bottom:5px; align-items:center; }
  button { margin-top: 10px; }
  select { margin-bottom: 20px; margin-right: 10px; }
</style>
</head>
<body>

<h1>Quiz</h1>

<label for="typeFilter">Select Type:</label>
<select id="typeFilter">
  <option value="">-- Select Type --</option>
</select>

<label for="difficultyFilter">Select Difficulty:</label>
<select id="difficultyFilter" disabled>
  <option value="">-- Select Difficulty --</option>
  <option value="easy">Easy</option>
  <option value="medium">Medium</option>
  <option value="hard">Hard</option>
</select>

<div id="quizContainer"></div>

<div>
  <button id="prevBtn">⬅ Previous</button>
  <button id="nextBtn">Next ➡</button>
  <button id="submitBtn">Submit Quiz</button>
</div>

<div id="scoreContainer" style="margin-top:20px;"></div>

<script type="module">
import { supabase } from './supabase.js';

let questions = [];
let currentIndex = 0;
let userAnswers = {}; // { question_id: [selected option ids] }

const quizContainer = document.getElementById('quizContainer');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const scoreContainer = document.getElementById('scoreContainer');
const typeFilter = document.getElementById('typeFilter');
const difficultyFilter = document.getElementById('difficultyFilter');

// Load distinct types from Supabase
async function loadTypes() {
  const { data, error } = await supabase
    .from('game_questions')
    .select('type', { count: 'exact', head: false })
    .neq('type', '')
    .order('type', { ascending: true });

  if(error) return alert(error.message);

  // Get unique types
  const types = [...new Set(data.map(q => q.type))];
  typeFilter.innerHTML = '<option value="">-- Select Type --</option>';
  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    typeFilter.appendChild(opt);
  });
}

// Load questions based on type and difficulty
async function loadQuestions() {
  const type = typeFilter.value;
  const difficulty = difficultyFilter.value;
  if(!type || !difficulty) return;

  const { data, error } = await supabase
    .from('game_questions')
    .select(`
      id,
      question_text,
      difficulty,
      type,
      game_question_options (
        id,
        option_text,
        is_correct
      )
    `)
    .eq('type', type)
    .eq('difficulty', difficulty)
    .order('created_at', { ascending: true });

  if(error) return alert(error.message);

  questions = data;
  currentIndex = 0;
  userAnswers = {};
  renderQuestion();
}

function renderQuestion() {
  if(questions.length === 0){
    quizContainer.innerHTML = 'No questions available for this type/difficulty.';
    return;
  }

  const q = questions[currentIndex];
  quizContainer.innerHTML = `
    <div class="question-container">
      <strong>Q${currentIndex + 1}: ${q.question_text}</strong> <br>
      Difficulty: ${q.difficulty} | Type: ${q.type || ''} <br><br>
      ${q.game_question_options.map(o => `
        <div class="choice">
          <label>
            <input type="checkbox" value="${o.id}" ${userAnswers[q.id]?.includes(o.id) ? 'checked' : ''} />
            ${o.option_text}
          </label>
        </div>
      `).join('')}
    </div>
  `;
}

function saveAnswer() {
  const q = questions[currentIndex];
  const checkedOptions = [...quizContainer.querySelectorAll('input[type="checkbox"]:checked')]
    .map(input => input.value);
  userAnswers[q.id] = checkedOptions;
}

// Navigation
prevBtn.onclick = () => { saveAnswer(); if(currentIndex > 0) currentIndex--; renderQuestion(); };
nextBtn.onclick = () => { saveAnswer(); if(currentIndex < questions.length - 1) currentIndex++; renderQuestion(); };

// Submit
submitBtn.onclick = () => {
  saveAnswer();
  let score = 0;
  questions.forEach(q => {
    const correctOptions = q.game_question_options.filter(o => o.is_correct).map(o => o.id);
    const selected = userAnswers[q.id] || [];
    if(correctOptions.length === selected.length && correctOptions.every(id => selected.includes(id))){
      score++;
    }
  });
  scoreContainer.innerHTML = `<h2>Your Score: ${score} / ${questions.length}</h2>`;
};

// Enable difficulty only after type is selected
typeFilter.onchange = () => {
  difficultyFilter.disabled = !typeFilter.value;
  loadQuestions();
};
difficultyFilter.onchange = loadQuestions;

// Initialize types
loadTypes();
</script>

</body>
</html>
